<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta de Validación: Cuidado de Adulto Mayor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .form-section {
            border-top: 8px solid #4a148c; /* Color similar a Google Forms */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4a148c;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dragging {
            opacity: 0.5;
            background: #f0f0f0;
        }
    </style>
</head>
<body class="bg-purple-50 flex justify-center items-start min-h-screen p-4 sm:p-8">
    <div class="w-full max-w-2xl">
        <!-- Encabezado del Formulario -->
        <div class="bg-white rounded-lg shadow-md form-section">
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-3xl font-bold text-gray-800">Validación de Servicio de Cuidado para Adulto Mayor</h1>
                <p class="text-sm text-gray-600 mt-4">Hola, mi nombre es Luis Silva y soy estudiante de Magíster de la Universidad de Chile. Esta encuesta es parte de mi tesis y busca entender los desafíos que enfrentan las familias en el **cuidado a domicilio** de sus padres mayores.</p>
                <p class="text-sm text-gray-600 mt-2">Tus respuestas son **100% anónimas y confidenciales** y serán de gran ayuda para mi investigación. ¡Muchas gracias por tu tiempo!</p>
            </div>
        </div>

        <!-- Sección 1: Preguntas de Filtro -->
        <div class="bg-white rounded-lg shadow-md mt-6 p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-1">Sección 1: Para comenzar</h2>
            <p class="text-sm text-gray-500 mb-6">Esta pregunta nos ayudará a dirigir la encuesta.</p>
            
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">1. ¿Actualmente participas de alguna manera en el cuidado de uno de tus padres o de un familiar mayor de 70 años? <span class="text-red-500">*</span></label>
                <div class="flex flex-col space-y-2">
                    <label class="flex items-center"><input type="radio" name="filtro_cuidado" value="si" class="mr-2"> Sí</label>
                    <label class="flex items-center"><input type="radio" name="filtro_cuidado" value="no" class="mr-2"> No</label>
                </div>
            </div>
        </div>
        
        <!-- Contenido para quienes respondieron SÍ -->
        <div id="path-yes" class="hidden">
            <div class="bg-white rounded-lg shadow-md mt-6 p-6">
                 <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">2. ¿Cuál es el nivel de dependencia de tu familiar? <span class="text-red-500">*</span></label>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center"><input type="radio" name="dependencia" class="mr-2" value="autovalente"> 1 - Es autovalente, solo necesita compañía y supervisión.</label>
                        <label class="flex items-center"><input type="radio" name="dependencia" class="mr-2" value="ayuda parcial"> 2 - Necesita ayuda para algunas actividades (ej. cocinar, compras).</label>
                        <label class="flex items-center"><input type="radio" name="dependencia" class="mr-2" value="dependencia moderada"> 3 - Dependencia moderada (necesita ayuda para moverse o vestirse).</label>
                        <label class="flex items-center"><input type="radio" name="dependencia" class="mr-2" value="dependencia alta"> 4 - Dependencia alta (requiere asistencia en la mayoría de las actividades).</label>
                        <label class="flex items-center"><input type="radio" name="dependencia" class="mr-2" value="dependencia total"> 5 - Dependencia total (postrado o con deterioro cognitivo severo).</label>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md mt-6 p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-1">Sección 2: Tu Experiencia con el Cuidado</h2>
                <p class="text-sm text-gray-500 mb-6">Queremos entender los desafíos reales que enfrentas.</p>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">3. Al pensar en el cuidado de tu familiar, por favor, ordena los siguientes desafíos del 1 (más difícil) al 4 (menos difícil). <span class="text-red-500">*</span></label>
                    <p class="text-xs text-gray-500 mb-3">(Haz clic y arrastra para ordenar)</p>
                    <div id="ranking-desafios" class="space-y-2 border p-3 rounded-md bg-gray-50">
                        <div class="p-2 bg-white border rounded-md cursor-move flex items-center" draggable="true" data-value="La carga emocional (culpa, estrés, ansiedad)"><svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>La carga emocional (culpa, estrés, ansiedad)</div>
                        <div class="p-2 bg-white border rounded-md cursor-move flex items-center" draggable="true" data-value="El tiempo y la logística que me consume"><svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>El tiempo y la logística que me consume</div>
                        <div class="p-2 bg-white border rounded-md cursor-move flex items-center" draggable="true" data-value="La coordinación con otros familiares"><svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>La coordinación con otros familiares</div>
                        <div class="p-2 bg-white border rounded-md cursor-move flex items-center" draggable="true" data-value="La carga económica"><svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>La carga económica</div>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">4. Si alguna vez has pensado en contratar ayuda profesional, ¿cuáles han sido las barreras que te han detenido? (Elige todas las que apliquen) <span class="text-red-500">*</span></label>
                     <div class="flex flex-col space-y-2">
                        <label class="flex items-center"><input type="checkbox" name="barrera" class="mr-2" value="Desconfianza"> No confío en dejar a mi familiar con un extraño.</label>
                        <label class="flex items-center"><input type="checkbox" name="barrera" class="mr-2" value="Costo"> El costo es demasiado alto.</label>
                        <label class="flex items-center"><input type="checkbox" name="barrera" class="mr-2" value="Deber personal"> Siento que es mi deber como hijo/a hacerlo yo mismo/a.</label>
                        <label class="flex items-center"><input type="checkbox" name="barrera" class="mr-2" value="No saber dónde buscar"> No sé dónde buscar a alguien calificado.</label>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md mt-6 p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-1">Sección 3: La Solución Ideal</h2>
                <p class="text-sm text-gray-500 mb-6">Ayúdanos a entender qué es lo más importante para ti.</p>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">5. Si fueras a contratar un servicio de cuidado, ¿qué te daría más confianza? (Elige las 2 opciones más importantes) <span class="text-red-500">*</span></label>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center"><input type="checkbox" name="confianza" class="mr-2"> Que el servicio realice un test psicológico al cuidador.</label>
                        <label class="flex items-center"><input type="checkbox" name="confianza" class="mr-2"> Que el cuidador tenga un título técnico o profesional (ej. TENS).</label>
                        <label class="flex items-center"><input type="checkbox" name="confianza" class="mr-2"> Tener acceso a referencias verificadas de otras familias.</label>
                        <label class="flex items-center"><input type="checkbox" name="confianza" class="mr-2"> Que el servicio ofrezca una garantía de reemplazo si no estoy conforme.</label>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">6. Más allá del cuidado básico y la seguridad, ¿qué servicio adicional valorarías más? (Elige solo uno) <span class="text-red-500">*</span></label>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center"><input type="radio" name="valor_agregado" class="mr-2" value="Actividades de estimulación"> Un plan de actividades de estimulación cognitiva y social para mi familiar.</label>
                        <label class="flex items-center"><input type="radio" name="valor_agregado" class="mr-2" value="Coordinación familiar"> Una plataforma para coordinar visitas y pagos con mis hermanos.</label>
                        <label class="flex items-center"><input type="radio" name="valor_agregado" class="mr-2" value="Informes diarios"> Informes diarios detallados sobre el estado y ánimo de mi familiar.</label>
                        <label class="flex items-center"><input type="radio" name="valor_agregado" class="mr-2" value="Acceso a otros profesionales"> Acceso a consultas con otros profesionales (kinesiólogos, nutricionistas).</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido para quienes respondieron NO -->
        <div id="path-no" class="hidden">
             <div class="bg-white rounded-lg shadow-md mt-6 p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-1">Sección 2: Tu Percepción sobre el Cuidado Futuro</h2>
                <p class="text-sm text-gray-500 mb-6">Aunque no participes directamente hoy, tu perspectiva como futuro cuidador es muy valiosa.</p>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">2. Pensando en el futuro, ¿cuáles crees que serán los mayores desafíos para ti y tu familia cuando deban gestionar el cuidado de sus padres? (Elige todos los que apliquen) <span class="text-red-500">*</span></label>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center"><input type="checkbox" name="desafio_no" class="mr-2" value="La carga emocional y el estrés."> La carga emocional y el estrés.</label>
                        <label class="flex items-center"><input type="checkbox" name="desafio_no" class="mr-2" value="El alto costo económico."> El alto costo económico.</label>
                        <label class="flex items-center"><input type="checkbox" name="desafio_no" class="mr-2" value="La falta de tiempo y la logística."> La falta de tiempo y la logística.</label>
                        <label class="flex items-center"><input type="checkbox" name="desafio_no" class="mr-2" value="La coordinación con otros familiares."> La coordinación con otros familiares.</label>
                    </div>
                </div>
                 <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">3. Si en el futuro necesitaras contratar ayuda profesional a domicilio, ¿cuáles serían tus mayores temores o preocupaciones? (Elige todos los que apliquen) <span class="text-red-500">*</span></label>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center"><input type="checkbox" name="temor_no" class="mr-2"> Que no traten bien a mi familiar (seguridad y calidad del trato).</label>
                        <label class="flex items-center"><input type="checkbox" name="temor_no" class="mr-2"> El alto costo que pueda tener.</label>
                        <label class="flex items-center"><input type="checkbox" name="temor_no" class="mr-2"> Perder el control de la situación y el cuidado de mi familiar.</label>
                        <label class="flex items-center"><input type="checkbox" name="temor_no" class="mr-2"> No encontrar a alguien realmente calificado y profesional.</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Final: Común para todos -->
        <div id="final-section" class="hidden">
            <div class="bg-white rounded-lg shadow-md mt-6 p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-1">Sección Final: Un poco sobre ti</h2>
                <p class="text-sm text-gray-500 mb-6">Estos datos son anónimos y nos ayudan a entender mejor las respuestas.</p>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Rango de Ingreso Mensual de tu Hogar (Líquido): <span class="text-red-500">*</span></label>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center"><input type="radio" name="ingreso" class="mr-2"> Menos de $700.000</label>
                        <label class="flex items-center"><input type="radio" name="ingreso" class="mr-2"> Entre $700.001 y $1.500.000</label>
                        <label class="flex items-center"><input type="radio" name="ingreso" class="mr-2"> Entre $1.500.001 y $2.500.000</label>
                        <label class="flex items-center"><input type="radio" name="ingreso" class="mr-2"> Entre $2.500.001 y $4.000.000</label>
                        <label class="flex items-center"><input type="radio" name="ingreso" class="mr-2"> Más de $4.000.000</label>
                    </div>
                </div>
                 <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Pensando en el financiamiento del cuidado, ¿cómo se cubre o se cubriría el costo? <span class="text-red-500">*</span></label>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center"><input type="radio" name="financiamiento" class="mr-2"> Principalmente con mis propios ingresos.</label>
                        <label class="flex items-center"><input type="radio" name="financiamiento" class="mr-2"> Se divide en partes iguales entre varios hermanos/familiares.</label>
                        <label class="flex items-center"><input type="radio" name="financiamiento" class="mr-2"> Un hermano/familiar aporta más que otros, pero es un esfuerzo compartido.</label>
                        <label class="flex items-center"><input type="radio" name="financiamiento" class="mr-2"> Principalmente con los ahorros o la pensión de mi familiar.</label>
                        <label class="flex items-center"><input type="radio" name="financiamiento" class="mr-2"> No lo hemos discutido aún.</label>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Comuna de Residencia (Región Metropolitana): <span class="text-red-500">*</span></label>
                    <select class="w-full p-2 border rounded-md">
                        <option>Cerrillos</option> <option>Cerro Navia</option> <option>Conchalí</option> <option>El Bosque</option> <option>Estación Central</option> <option>Huechuraba</option> <option>Independencia</option> <option>La Cisterna</option> <option>La Florida</option> <option>La Granja</option> <option>La Pintana</option> <option>La Reina</option> <option>Las Condes</option> <option>Lo Barnechea</option> <option>Lo Espejo</option> <option>Lo Prado</option> <option>Macul</option> <option>Maipú</option> <option>Ñuñoa</option> <option>Pedro Aguirre Cerda</option> <option>Peñalolén</option> <option>Providencia</option> <option>Pudahuel</option> <option>Quilicura</option> <option>Quinta Normal</option> <option>Recoleta</option> <option>Renca</option> <option>San Joaquín</option> <option>San Miguel</option> <option>San Ramón</option> <option>Santiago</option> <option>Vitacura</option> <option>Padre Hurtado</option> <option>Peñaflor</option> <option>Talagante</option> <option>Isla de Maipo</option> <option>El Monte</option> <option>Melipilla</option> <option>San Pedro</option> <option>Alhué</option> <option>Curacaví</option> <option>María Pinto</option> <option>Buin</option> <option>Paine</option> <option>San Bernardo</option> <option>Calera de Tango</option> <option>Colina</option> <option>Lampa</option> <option>Tiltil</option> <option>San José de Maipo</option> <option>Pirque</option> <option>Puente Alto</option>
                    </select>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md mt-6 p-6">
                 <h3 class="text-lg font-bold text-purple-800">✨ Tu Agradecimiento Personalizado</h3>
                 <p class="text-sm text-gray-600 mt-2">Basado en tus respuestas, podemos generar con IA un pequeño plan de acción con consejos para ayudarte. ¡Es nuestro agradecimiento por tu tiempo!</p>
                 <button id="gemini-button" class="mt-4 w-full bg-purple-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-800 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500">
                    Generar mi plan de acción
                 </button>
                 <div id="gemini-loading" class="hidden flex justify-center items-center mt-4">
                     <div class="loader"></div>
                 </div>
                 <div id="gemini-result" class="hidden mt-4 p-4 bg-purple-100 border border-purple-200 rounded-lg text-gray-800"></div>
            </div>
            <div class="mt-6">
                <button class="w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors">Enviar Encuesta</button>
            </div>
        </div>
    </div>

    <script>
        const filtroRadios = document.querySelectorAll('input[name="filtro_cuidado"]');
        const pathYes = document.getElementById('path-yes');
        const pathNo = document.getElementById('path-no');
        const finalSection = document.getElementById('final-section');

        filtroRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                finalSection.classList.remove('hidden');
                if (event.target.value === 'si') {
                    pathYes.classList.remove('hidden');
                    pathNo.classList.add('hidden');
                } else {
                    pathNo.classList.remove('hidden');
                    pathYes.classList.add('hidden');
                }
            });
        });

        // --- Lógica para ordenar (Drag and Drop) ---
        const sortableList = document.getElementById('ranking-desafios');
        let draggedItem = null;

        sortableList.addEventListener('dragstart', (e) => {
            draggedItem = e.target;
            setTimeout(() => {
                e.target.classList.add('dragging');
            }, 0);
        });

        sortableList.addEventListener('dragend', (e) => {
            setTimeout(() => {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }, 0);
        });

        sortableList.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(sortableList, e.clientY);
            if (afterElement == null) {
                sortableList.appendChild(draggedItem);
            } else {
                sortableList.insertBefore(draggedItem, afterElement);
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }


        const geminiButton = document.getElementById('gemini-button');
        const geminiLoading = document.getElementById('gemini-loading');
        const geminiResult = document.getElementById('gemini-result');

        geminiButton.addEventListener('click', async () => {
            geminiButton.disabled = true;
            geminiLoading.classList.remove('hidden');
            geminiResult.classList.add('hidden');
            geminiResult.innerHTML = '';

            let prompt = "";
            const esCuidador = document.querySelector('input[name="filtro_cuidado"]:checked')?.value === 'si';

            if(esCuidador) {
                const dependencia = document.querySelector('input[name="dependencia"]:checked')?.value || "no especificado";
                const rankedChallenges = document.getElementById('ranking-desafios').firstElementChild.getAttribute('data-value');
                const barrera = document.querySelector('input[name="barrera"]:checked')?.value || "no especificada";
                const valorAgregado = document.querySelector('input[name="valor_agregado"]:checked')?.value || "no especificado";
                
                prompt = `
                    Eres un asistente empático y experto en el cuidado de adultos mayores. Un hijo/a a cargo de su padre/madre acaba de completar una encuesta. Su situación es la siguiente:
                    - Nivel de dependencia del familiar: ${dependencia}.
                    - Su principal desafío es: '${rankedChallenges}'.
                    - Su principal barrera para contratar ayuda es: ${barrera}.
                    - El servicio adicional que más valora es: ${valorAgregado}.

                    Basado en esta información, genera una respuesta de 3 a 4 párrafos que ofrezca:
                    1. Validación y empatía por su situación específica.
                    2. Dos o tres sugerencias prácticas y accionables que podrían ayudarle a aliviar su carga, conectando con sus desafíos y barreras.
                    3. Un mensaje de aliento.
                    El tono debe ser de apoyo y no médico. Habla directamente a la persona (ej. 'Entiendo que te sientas así...'). Formatea la respuesta en HTML con párrafos <p> y una lista <ul> para las sugerencias.
                `;
            } else {
                 const desafioNo = document.querySelector('input[name="desafio_no"]:checked')?.value || "no especificado";
                 prompt = `
                    Eres un asistente empático y experto en el cuidado de adultos mayores. Una persona que no es cuidadora directa acaba de responder que, desde su perspectiva, el mayor desafío para las familias que cuidan es '${desafioNo}'.
                    Basado en esto, genera una respuesta de 2 a 3 párrafos que:
                    1. Agradezca su perspectiva.
                    2. Ofrezca una o dos ideas simples sobre cómo alguien que no es el cuidador principal puede apoyar a los que sí lo son, basándose en el desafío que identificó.
                    3. Un mensaje positivo sobre la importancia del apoyo de toda la red familiar.
                    El tono debe ser de apoyo. Formatea la respuesta en HTML con párrafos <p>.
                `;
            }
            
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "" // Se deja vacío para que Canvas lo gestione
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    geminiResult.innerHTML = generatedText;
                } else {
                    geminiResult.innerHTML = "<p>Lo sentimos, no pudimos generar una respuesta en este momento. Por favor, inténtalo de nuevo más tarde.</p>";
                }

            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                geminiResult.innerHTML = "<p>Ocurrió un error al procesar tu solicitud. Por favor, verifica tu conexión a internet.</p>";
            } finally {
                geminiLoading.classList.add('hidden');
                geminiResult.classList.remove('hidden');
                geminiButton.disabled = false;
            }
        });

        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (retries > 0 && (response.status === 429 || response.status >= 500)) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithRetry(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }
    </script>
</body>
</html>
